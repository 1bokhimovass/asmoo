<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ishlab chiqarish - ASMO AVTO</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="config.js"></script>
    <style>
      :root {
        --bg-color: #f8f9fa;
        --primary-color: #0d6efd;
      }
      body {
        background-color: var(--bg-color);
        font-family: "Segoe UI", sans-serif;
        padding-bottom: 50px;
      }
      .card-form {
        border-radius: 20px;
        border: none;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
      }
      .dynamic-row {
        background: #f1f3f5;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 5px solid var(--primary-color);
      }
      .price-auto {
        background-color: #e9ecef !important;
        font-weight: bold;
        color: #d63384 !important;
      }
      .table-custom {
        background: white;
        border-radius: 15px;
        overflow: hidden;
      }
      .text-qty {
        color: #007f5f;
        font-weight: bold;
      }

      /* ORQAGA QAYTISH TUGMASI USLUBI */
      .btn-back {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 600;
        margin-bottom: 20px;
        transition: 0.3s;
        padding: 5px 10px;
        border-radius: 8px;
        background: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      .btn-back:hover {
        transform: translateX(-5px);
        background: #e9ecef;
        color: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <a href="javascript:history.back()" class="btn-back">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          fill="currentColor"
          viewBox="0 0 16 16"
        >
          <path
            fill-rule="evenodd"
            d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"
          />
        </svg>
        Orqaga qaytish
      </a>

      <div class="row justify-content-center">
        <div class="col-12 col-md-10">
          <div class="card card-form p-4 mb-4">
            <h4 class="text-center fw-bold mb-4 text-primary" id="page-title">
              üèóÔ∏è ISHLAB CHIQARISH
            </h4>

            <div class="mb-3">
              <label class="form-label fw-bold small"
                >Partiya raqami (Batch ID)</label
              >
              <input
                type="text"
                id="batch_id"
                class="form-control fw-bold border-primary"
                placeholder="#P-2026"
              />
            </div>

            <div id="dynamic_rows_container">
              <div class="dynamic-row">
                <div class="mb-2 size-select-box">
                  <label class="form-label fw-bold small"
                    >O'lcham va Kodni tanlang</label
                  >
                  <select
                    class="form-select item-select fw-bold"
                    onchange="handleSizeChange(this)"
                  >
                    <option value="" disabled selected hidden>
                      -- Tanlang --
                    </option>
                    <option value="12.7mm|VE0017GMK">12.7mm - VE0017GMK</option>
                    <option value="12.7mm|VE001VAP">12.7mm - VE001VAP</option>
                    <option value="19.5mm|VE2004">19.5mm - VE2004</option>
                    <option value="40.20mm|VE0020GMC">
                      40.20mm - VE0020GMC
                    </option>
                    <option value="27.27mm|VE2084">27.27mm - VE2084</option>
                  </select>
                </div>

                <div class="row g-2">
                  <div class="col-6">
                    <label class="form-label small fw-bold"
                      >Miqdori (dona)</label
                    >
                    <input
                      type="number"
                      class="form-control item-qty fw-bold border-success"
                      placeholder="0"
                    />
                  </div>
                  <div class="col-6">
                    <label class="form-label small fw-bold">Dona narxi</label>
                    <input
                      type="number"
                      class="form-control item-price"
                      placeholder="0.00"
                    />
                  </div>
                </div>
              </div>
            </div>

            <button
              id="add-row-btn"
              class="btn btn-outline-primary btn-sm w-100 mb-3 fw-bold"
              onclick="addNewRow()"
            >
              + YANA QO'SHISH
            </button>
            <button
              class="btn btn-success btn-lg w-100 fw-bold shadow"
              onclick="saveAll()"
            >
              ‚úÖ BARCHASINI SAQLASH
            </button>
          </div>

          <table class="table table-custom align-middle shadow-sm">
            <thead class="table-dark">
              <tr>
                <th>Batch / Vaqt</th>
                <th>Ma'lumot</th>
                <th class="text-end">Summa</th>
              </tr>
            </thead>
            <tbody id="archive-table"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      const gorePrices = {
        "12.7mm|VE0017GMK": 1273.68,
        "12.7mm|VE001VAP": 1188.81,
        "19.5mm|VE2004": 3134.15,
        "40.20mm|VE0020GMC": 4539.11,
        "27.27mm|VE2084": 4353.73,
      };

      const savedTitle = (
        localStorage.getItem("activeSubTitle") || ""
      ).toUpperCase();
      const isGore = savedTitle.includes("GORE");
      let filterName = isGore
        ? "GORE-TEX PATCH"
        : savedTitle.includes("LED")
        ? "LED PCB"
        : "AVTO SWITCH";

      document.getElementById("page-title").innerText =
        "üèóÔ∏è " + filterName + " ISHLAB CHIQARISH";

      function setupUI() {
        const rows = document.querySelectorAll(".dynamic-row");
        rows.forEach((row) => {
          const selectBox = row.querySelector(".size-select-box");
          const priceInput = row.querySelector(".item-price");
          if (!isGore) {
            selectBox.style.display = "none";
            priceInput.classList.remove("price-auto");
            priceInput.readOnly = false;
          } else {
            priceInput.classList.add("price-auto");
            priceInput.readOnly = true;
          }
        });
      }

      function handleSizeChange(selectElement) {
        if (!isGore) return;
        const row = selectElement.closest(".dynamic-row");
        row.querySelector(".item-price").value =
          gorePrices[selectElement.value] || "";
      }

      function addNewRow() {
        const container = document.getElementById("dynamic_rows_container");
        const firstRow = container.querySelector(".dynamic-row");
        const div = document.createElement("div");
        div.className = "dynamic-row";
        div.innerHTML = firstRow.innerHTML;

        // Yangi qatordagi inputlarni tozalash
        div.querySelector(".item-qty").value = "";
        div.querySelector(".item-price").value = isGore ? "" : "0";
        if (isGore) div.querySelector(".item-select").selectedIndex = 0;

        container.appendChild(div);
        setupUI();
      }

      async function saveAll() {
        const batch = document.getElementById("batch_id").value.trim();
        if (!batch) return alert("Batch ID kiriting!");

        const rows = document.querySelectorAll(".dynamic-row");
        const timeNow = new Date().toLocaleString("uz-UZ");

        try {
          for (let row of rows) {
            const select = row.querySelector(".item-select");
            const qty = parseInt(row.querySelector(".item-qty").value);
            const price = parseFloat(row.querySelector(".item-price").value);

            if (qty > 0 && price > 0) {
              let size = "",
                code = "",
                safeKey = "stock_gen_" + filterName.replace(/\s+/g, "_");

              if (isGore && select.value) {
                [size, code] = select.value.split("|");
                safeKey =
                  "stock_gore_" + size.replace(/[.|]/g, "_") + "_" + code;
              }

              const data = {
                product: filterName,
                batch,
                size,
                code,
                qty,
                price,
                jami_summa: qty * price,
                time: timeNow,
                timestamp: Date.now(),
              };

              await db.ref("asmo_all_history").push(data);
              await db
                .ref("asmo_inventory_balance")
                .child(safeKey)
                .transaction((c) => (c || 0) + qty);
            }
          }
          alert("‚úÖ Saqlandi!");
          location.reload();
        } catch (e) {
          alert("Xatolik: " + e.message);
        }
      }

      function loadRecords() {
        db.ref("asmo_all_history")
          .limitToLast(50)
          .on("value", (snap) => {
            const table = document.getElementById("archive-table");
            table.innerHTML = "";
            if (snap.exists()) {
              Object.values(snap.val())
                .reverse()
                .forEach((item) => {
                  if (item.product === filterName) {
                    const info = isGore
                      ? `${item.code} / ${item.size}`
                      : item.product;
                    table.innerHTML += `
                  <tr>
                    <td><b>${item.batch}</b><br><small class="text-muted">${
                      item.time
                    }</small></td>
                    <td><span class="text-qty">${
                      item.qty
                    } dona</span><br><small>${info}</small></td>
                    <td class="text-end"><b>${item.jami_summa.toLocaleString()}</b> so'm</td>
                  </tr>`;
                  }
                });
            }
          });
      }

      window.onload = () => {
        setupUI();
        loadRecords();
      };
    </script>
  </body>
</html>
